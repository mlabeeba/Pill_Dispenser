{% block content %}

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Schedule Medication</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='schedule-med-style.css') }}">
        <script src="{{ url_for('static', filename='popup.js') }}"></script>
    </head>

    <div class="schedule-popup-content">
        <h2>Schedule Medication</h2>
        <p>Fill in the details below:</p>

        <form id="scheduleForm">
            <label for="medication">Medication:</label>
            <select id="medication" name="medication">
                <option value=""></option>
            </select>

            <label for="scheduleDate">Start Date:</label>
            <input type="date" id="scheduleStartDate" name="scheduleDate">
            <label for="scheduleDate">End Date:</label>
            <input type="date" id="scheduleEndDate" name="scheduleDate">

            <div class="tab">
                <button type="button" class="tablinks" data-type="time">Schedule Time</button>
                <button type="button" class="tablinks" data-type="interval">Schedule Interval</button>
            </div>

            <div id="time" class="tabcontent">
                <label for="scheduleTime">Select Time:</label>
                <input type="time" id="scheduleTime" name="scheduleTime">
            </div>

            <div id="interval" class="tabcontent">
                <label for="intervalHours">Dispense Every:</label>
                <div class="interval-input">
                    <input type="number" id="intervalValue" name="intervalValue" min="1">
                    <select id="intervalUnit" name="intervalUnit">
                        <option value="seconds">sec</option>
                        <option value="minutes">min</option>
                        <option value="hours">hour</option>
                    </select>
                </div>
            </div>

            <div class="popup-actions">
                <button type="button" id="cancelScheduleButton">Cancel</button>
                <button type="submit" id="saveScheduleButton">Save</button>
            </div>
        </form>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Get selected patient ID from sessionStorage (set in medications page)
            const selectedPatientId = sessionStorage.getItem("selectedPatientId");

            function fetchMedicationsForSelectedPatient() {
                if (!selectedPatientId) {
                    console.error("❌ No patient selected in session!");
                    return;
                }

                fetch(`/get_medications/${selectedPatientId}`)
                    .then(response => response.json())
                    .then(data => {
                        const medicationDropdown = document.getElementById("medication");
                        medicationDropdown.innerHTML = '<option value=""> </option>'; // Reset dropdown

                        data.forEach(med => {
                            let option = document.createElement("option");
                            option.value = med.med_id;
                            option.textContent = med.med_name;
                            medicationDropdown.appendChild(option);
                        });
                    })
                    .catch(error => console.error("❌ Error fetching medications:", error));
            }

            // Fetch medications when the popup opens
            fetchMedicationsForSelectedPatient();
        });
    </script>

{% endblock %}
